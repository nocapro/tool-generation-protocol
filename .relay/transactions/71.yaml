uuid: c8f3a9d2-1b4e-4e5f-9a0b-2c3d4e5f6a7b
projectId: tool-generation-protocol
createdAt: '2025-11-28T09:59:41.790Z'
gitCommitMsg: >-
  fix(test): update MockLanguageModelV2 responses to match AI SDK V2 spec

  Replaces legacy `toolCalls` and `text` properties with the standardized
  `content` array structure required by the Vercel AI SDK Core V2. This resolves
  the `TypeError` during integration tests.
promptSummary: >-
  Fix Vercel AI SDK V2 MockModel response structure to use 'content' array
  instead of legacy properties.
reasoning:
  - >-
    To fix the `TypeError: undefined is not an object (evaluating
    'currentModelResponse.content.filter')` error, we need to update the mock
    responses in `test/integration/vercel.test.ts` to conform to the **Vercel AI
    SDK Language Model V2 specification**.
  - >-
    The V2 specification requires `doGenerate` to return an object containing a
    `content` array (composed of typed parts like `text` or `tool-call`), rather
    than top-level `text` or `toolCalls` properties which were used in V1 or
    transitional versions.
  - '### Changes:'
  - '1.  **`test/integration/vercel.test.ts`**:'
  - >-
    *   Updated the first mock response (Tool Call) to return `content` with a
    `tool-call` part.
  - >-
    *   Changed `args` from a JSON string to a plain object, as V2 providers
    typically return parsed arguments (or the SDK handles object args natively
    in the mock).
  - >-
    *   Updated the second mock response (Final Text) to return `content` with a
    `text` part.
operations:
  - type: write
    path: test/integration/vercel.test.ts
    content: >
      --- test/integration/vercel.test.ts

      +++ test/integration/vercel.test.ts

      @@ -41,13 +41,10 @@
               rawCall: { raw: 'call' },
               finishReason: 'tool-calls',
               usage: { promptTokens: 10, completionTokens: 10 },
      -        toolCalls: [

      +        content: [
                 {
      -            toolCallType: 'function',

      -            toolCallId: 'call_1',

      -            toolName: 'write_file',

      -            // Vercel SDK expects args as a JSON string

      -            args: JSON.stringify({ path: 'tools/hello-vercel.ts',
      content: 'export default "compat"' }),

      +            type: 'tool-call',

      +            toolCallId: 'call_1',

      +            toolName: 'write_file',

      +            args: { path: 'tools/hello-vercel.ts', content: 'export
      default "compat"' },
                 }
               ]
             }),
      @@ -62,7 +59,7 @@
                 rawCall: { raw: 'response' },
                 finishReason: 'stop',
                 usage: { promptTokens: 20, completionTokens: 5 },
      -          text: 'File created successfully.'

      +          content: [{ type: 'text', text: 'File created successfully.' }]
               };
             }
           ]);
    patchStrategy: standard-diff
snapshot:
  test/integration/vercel.test.ts: >-
    import { describe, it, expect, beforeEach, afterEach } from 'bun:test';

    import * as fs from 'fs/promises';

    import * as path from 'path';

    import { generateText } from 'ai';

    import { createTempDir, createTgpConfig, cleanupDir, initBareRepo } from
    '../e2e/utils.js';

    import { TGP } from '../../src/tgp.js';

    import { tgpTools } from '../../src/tools/index.js';

    import { MockLanguageModelV2 } from '../fixtures/fake-model.js';


    describe('Integration: Vercel AI SDK Compatibility', () => {
      let tempDir: string;
      let remoteRepo: string;

      beforeEach(async () => {
        tempDir = await createTempDir('tgp-int-vercel-');
        remoteRepo = await createTempDir('tgp-remote-');
        await initBareRepo(remoteRepo);
      });

      afterEach(async () => {
        await cleanupDir(tempDir);
        await cleanupDir(remoteRepo);
      });

      it('End-to-End: generateText executes TGP tools correctly', async () => {
        // 1. Setup Kernel
        const configPath = await createTgpConfig(tempDir, remoteRepo);
        const kernel = new TGP({ configFile: configPath });
        await kernel.boot();

        // 2. Prepare Toolset
        const tools = tgpTools(kernel);

        // 3. Setup Fake Model Interaction
        // The interaction simulates:
        // Turn 1: Model receives user prompt -> Calls 'write_file'
        // Turn 2: Model receives tool result -> Returns final text
        const mockModel = new MockLanguageModelV2([
          // Response 1: Request Tool Execution
          () => ({
            rawCall: { raw: 'call' },
            finishReason: 'tool-calls',
            usage: { promptTokens: 10, completionTokens: 10 },
            toolCalls: [
              {
                toolCallType: 'function',
                toolCallId: 'call_1',
                toolName: 'write_file',
                // Vercel SDK expects args as a JSON string
                args: JSON.stringify({ path: 'tools/hello-vercel.ts', content: 'export default "compat"' }),
              }
            ]
          }),
          // Response 2: Final Summary
          (opts) => {
            // Assert that the SDK fed the tool result back to the model
            const lastMsg = opts.prompt[opts.prompt.length - 1];
            if (lastMsg.role !== 'tool' || lastMsg.content[0].type !== 'tool-result') {
              throw new Error('Expected last message to be a tool result');
            }
            
            return {
              rawCall: { raw: 'response' },
              finishReason: 'stop',
              usage: { promptTokens: 20, completionTokens: 5 },
              text: 'File created successfully.'
            };
          }
        ]);

        // 4. Execute using Vercel AI SDK
        const result = await generateText({
          model: mockModel,
          tools: tools, // Type Check: This must compile
          maxSteps: 2,  // Allow tool roundtrips
          prompt: 'Create a file named tools/hello-vercel.ts',
        });

        // 5. Verify Results
        expect(result.text).toBe('File created successfully.');
        expect(result.toolCalls.length).toBe(1);
        expect(result.toolCalls[0].toolName).toBe('write_file');

        // 6. Verify Side Effects (Real Filesystem Check)
        // The VFS root is at .tgp inside tempDir (configured by createTgpConfig)
        const targetFile = path.join(tempDir, '.tgp/tools/hello-vercel.ts');
        const exists = await fs.access(targetFile).then(() => true).catch(() => false);
        
        expect(exists).toBe(true);
        
        const content = await fs.readFile(targetFile, 'utf-8');
        expect(content).toBe('export default "compat"');
      });
    });
approved: true
linesAdded: 4
linesRemoved: 5
linesDifference: 9
gitCommittedAt: '2025-11-28T10:05:13.195Z'
status: committed
id: 71
