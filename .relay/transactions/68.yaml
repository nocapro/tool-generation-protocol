uuid: 62434211-8950-40e0-b954-def25aa3796f
projectId: tool-generation-protocol
createdAt: '2025-11-28T08:30:05.147Z'
gitCommitMsg: >-
  fix(test): restrict bun test scope and improve runtime detection

  - Point 'bun test' to 'test/' dir to avoid running compiled JS in 'dist/' -
  Use 'typeof Bun' for robust environment detection in SQL tests to prevent
  loading better-sqlite3 in Bun - Add 'Bun' to eslint globals
promptSummary: >-
  Fix test crashes in Bun by ignoring 'dist' directory during tests and
  improving Bun runtime detection in SQL integration tests to avoid loading
  incompatible 'better-sqlite3' module.
reasoning:
  - >-
    This issue arises because `bun test` is picking up the compiled JavaScript
    files in `dist/` (generated by `npm run build` in `pretest`) in addition to
    or instead of the TypeScript source files. The compiled files in `dist/`
    might have issues with environment detection logic (`isBun`) or just be
    redundant/stale.
  - >-
    Additionally, `better-sqlite3` is a native Node.js module that has ABI
    compatibility issues with Bun. The test code attempts to conditionally load
    it, but the detection logic needs to be robust to ensure `better-sqlite3` is
    never loaded when running inside Bun.
  - 'Here are the fixes:'
  - >-
    1.  **`package.json`**: Restrict `bun test` to the `test/` directory to
    ignore `dist/`.
  - >-
    2.  **`test/integration/sql.test.ts`**: Use `typeof Bun !== 'undefined'` for
    robust runtime detection.
  - '3.  **`eslint.config.js`**: Allow the `Bun` global to avoid lint errors.'
operations:
  - type: write
    path: package.json
    content: |
      --- package.json
      +++ package.json
      @@ -16,3 +16,3 @@
           "pretest": "npm run build",
      -    "test": "bun test",
      +    "test": "bun test test/",
           "tgp": "node bin/tgp.js"
    patchStrategy: standard-diff
  - type: write
    path: test/integration/sql.test.ts
    content: >
      --- test/integration/sql.test.ts

      +++ test/integration/sql.test.ts

      @@ -33,4 +33,3 @@
       async function createTestDB(): Promise<TestDB> {
      -  // eslint-disable-next-line @typescript-eslint/no-explicit-any

      -  const isBun = typeof process !== 'undefined' && (process.versions as
      any).bun;

      +  const isBun = typeof Bun !== 'undefined';
       
    patchStrategy: standard-diff
  - type: write
    path: eslint.config.js
    content: |
      --- eslint.config.js
      +++ eslint.config.js
      @@ -13,4 +13,5 @@
             globals: {
               console: 'readonly',
      +        Bun: 'readonly',
               process: 'readonly',
               Buffer: 'readonly',
    patchStrategy: standard-diff
snapshot:
  package.json: |-
    {
      "name": "@tgp/core",
      "version": "0.0.1",
      "description": "The Tool Generation Protocol",
      "main": "dist/src/index.js",
      "types": "dist/src/index.d.ts",
      "type": "module",
      "scripts": {
        "build": "tsc",
        "dev": "tsx src/cli/index.ts",
        "lint": "eslint src/**/*.ts",
        "lint:fix": "eslint src/**/*.ts --fix",
        "pretest": "npm run build",
        "test": "bun test",
        "tgp": "node bin/tgp.js"
      },
      "keywords": [
        "ai",
        "agent",
        "protocol",
        "backend"
      ],
      "author": "",
      "license": "MIT",
      "bin": {
        "tgp": "./bin/tgp.js"
      },
      "dependencies": {
        "esbuild": "^0.19.12",
        "isolated-vm": "^6.0.2",
        "isomorphic-git": "^1.35.1",
        "zod": "^3.25.76",
        "zod-to-json-schema": "^3.22.4",
        "typescript": "^5.9.3"
      },
      "devDependencies": {
        "@types/node": "^20.19.25",
        "@types/better-sqlite3": "^7.6.9",
        "@typescript-eslint/eslint-plugin": "^8.48.0",
        "@typescript-eslint/parser": "^8.48.0",
        "better-sqlite3": "^9.4.3",
        "eslint": "^9.39.1",
        "tsx": "^4.16.2",
        "bun-types": "^1.1.12"
      }
    }
  test/integration/sql.test.ts: >-
    import { describe, it, expect, beforeEach, afterEach } from 'bun:test';

    import { createTempDir, createTgpConfig, cleanupDir, initBareRepo } from
    '../e2e/utils.js';

    import { TGP } from '../../src/tgp.js';

    import { tgpTools, createSqlTools } from '../../src/tools/index.js';


    // Abstraction for DB differences between Node (better-sqlite3) and Bun
    (bun:sqlite)

    // This ensures tests run natively in Bun without 'better-sqlite3' ABI
    issues,

    // while maintaining Node compatibility.

    interface TestDB {
      exec(sql: string): void;
      prepare(sql: string): {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        all(...params: any[]): any[];
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        get(...params: any[]): any;
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        run(...params: any[]): any;
      };
      close(): void;
    }


    async function createTestDB(): Promise<TestDB> {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const isBun = typeof process !== 'undefined' && (process.versions as any).bun;

      if (isBun) {
        // Dynamic import to avoid build-time errors/resolutions in Node
        const { Database } = await import('bun:sqlite'); 
        const db = new Database(':memory:');
        return {
          exec: (sql: string) => db.run(sql),
          prepare: (sql: string) => {
            const query = db.query(sql);
            return {
              all: (...params: any[]) => query.all(...params),
              get: (...params: any[]) => query.get(...params),
              run: (...params: any[]) => query.run(...params),
            };
          },
          close: () => db.close(),
        };
      } else {
        const { default: Database } = await import('better-sqlite3');
        const db = new Database(':memory:');
        return {
          exec: (sql: string) => db.exec(sql),
          prepare: (sql: string) => {
            const stmt = db.prepare(sql);
            return {
              all: (...params: any[]) => stmt.all(...params),
              get: (...params: any[]) => stmt.get(...params),
              run: (...params: any[]) => stmt.run(...params),
            };
          },
          close: () => db.close(),
        };
      }
    }


    describe('Integration: SQL Adapter (Real SQLite)', () => {
      let tempDir: string;
      let remoteRepo: string;
      let db: TestDB;

      beforeEach(async () => {
        tempDir = await createTempDir('tgp-int-sql-');
        remoteRepo = await createTempDir('tgp-remote-');
        await initBareRepo(remoteRepo);
        
        // Setup Real SQLite DB (In-memory for speed/isolation)
        db = await createTestDB();
        db.exec('CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)');
        db.exec("INSERT INTO users (name) VALUES ('Alice')");
        db.exec("INSERT INTO users (name) VALUES ('Bob')");
      });

      afterEach(async () => {
        if (db) db.close();
        await cleanupDir(tempDir);
        await cleanupDir(remoteRepo);
      });

      it('Query Execution: Tool can query real database', async () => {
        const configPath = await createTgpConfig(tempDir, remoteRepo);
        
        // Executor that bridges TGP -> Real DB
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const executor = async (sql: string, params: any[]) => {
          const stmt = db.prepare(sql);
          if (sql.trim().toLowerCase().startsWith('select')) {
            return stmt.all(...params);
          }
          return stmt.run(...params);
        };

        const kernel = new TGP({ 
          configFile: configPath,
          sandboxAPI: { exec_sql: executor } // Inject for internal usage if needed
        });
        await kernel.boot();

        // Compose tools
        const tools = { ...tgpTools(kernel), ...createSqlTools(executor) };

        const toolName = 'tools/get_users.ts';
        await tools.write_file.execute({
          path: toolName,
          content: `
            export default async function() {
              return await tgp.exec_sql('SELECT name FROM users ORDER BY name', []);
            }
          `
        });

        const res = await tools.exec_tool.execute({ path: toolName, args: {} });
        
        expect(res.success).toBe(true);
        expect(res.result).toEqual([{ name: 'Alice' }, { name: 'Bob' }]);
      });

      it('Transaction Rollback: Host can rollback if tool throws', async () => {
        const configPath = await createTgpConfig(tempDir, remoteRepo);
        
        // Executor
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const executor = async (sql: string, params: any[]) => {
          return db.prepare(sql).run(...params);
        };

        const kernel = new TGP({ configFile: configPath });
        await kernel.boot();
        const tools = { ...tgpTools(kernel), ...createSqlTools(executor) };

        // Create a buggy tool that writes then crashes
        const buggyTool = 'tools/buggy_insert.ts';
        await tools.write_file.execute({
          path: buggyTool,
          content: `
            export default async function() {
               // 1. Write
               await tgp.exec_sql("INSERT INTO users (name) VALUES ('Charlie')", []);
               // 2. Crash
               throw new Error('Logic Bomb');
            }
          `
        });

        // Emulate Host Application Transaction Wrapper
        // Since we manage transaction via raw SQL commands
        // surrounding the async tool execution.
        
        db.exec('BEGIN');
        let errorCaught = false;
        
        try {
          const res = await tools.exec_tool.execute({ path: buggyTool, args: {} });
          if (!res.success) {
            throw new Error(res.error);
          }
          db.exec('COMMIT');
        } catch (e) {
          errorCaught = true;
          db.exec('ROLLBACK');
        }

        expect(errorCaught).toBe(true);

        // Verify 'Charlie' was NOT added
        const rows = db.prepare('SELECT * FROM users WHERE name = ?').all('Charlie');
        expect(rows.length).toBe(0);
        
        // Verify existing data remains
        const count = db.prepare('SELECT count(*) as c FROM users').get() as { c: number };
        expect(count.c).toBe(2);
      });
    });
  eslint.config.js: |-
    import typescriptESLint from '@typescript-eslint/eslint-plugin';
    import typescriptParser from '@typescript-eslint/parser';

    export default [
      {
        files: ['src/**/*.ts', 'test/**/*.ts'],
        languageOptions: {
          parser: typescriptParser,
          parserOptions: {
            ecmaVersion: 2022,
            sourceType: 'module',
            project: './tsconfig.json',
          },
          globals: {
            console: 'readonly',
            process: 'readonly',
            Buffer: 'readonly',
            __dirname: 'readonly',
            __filename: 'readonly',
            global: 'readonly',
            describe: 'readonly',
            it: 'readonly',
            expect: 'readonly',
            beforeEach: 'readonly',
            afterEach: 'readonly',
          },
        },
        plugins: {
          '@typescript-eslint': typescriptESLint,
        },
        rules: {
          '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
          '@typescript-eslint/no-explicit-any': 'warn',
          '@typescript-eslint/no-non-null-assertion': 'warn',
          '@typescript-eslint/no-empty-function': 'error',
          '@typescript-eslint/no-unnecessary-type-assertion': 'error',
          '@typescript-eslint/prefer-as-const': 'error',
          '@typescript-eslint/prefer-nullish-coalescing': 'error',
          '@typescript-eslint/prefer-optional-chain': 'error',
          '@typescript-eslint/strict-boolean-expressions': 'error',
          'no-console': 'warn',
          'no-debugger': 'error',
          'no-unused-expressions': 'error',
          'prefer-const': 'error',
          'no-var': 'error',
        },
      },
      {
        ignores: ['dist/', 'node_modules/', '*.js'],
      },
    ];
approved: true
linesAdded: 3
linesRemoved: 3
linesDifference: 6
gitCommittedAt: null
status: committed
id: 68
