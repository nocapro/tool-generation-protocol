uuid: c29f0e34-5d9c-4f1a-9b1b-6f8e7a0c1d2e
projectId: tool-generation-protocol
createdAt: '2025-11-28T02:47:30.942Z'
gitCommitMsg: >-
  fix(sandbox): lazy load isolated-vm to support portable testing and prevent
  boot crash
promptSummary: >-
  Fixed 'isolated-vm' import to be lazy/dynamic, preventing test runner crash in
  non-Node environments (like Bun) or when native bindings are missing.
reasoning:
  - >-
    The error `Cannot find module './out/isolated_vm'` occurs because
    `isolated-vm` is a native Node.js module that attempts to load a C++ binary
    on initialization. When running tests with `bun test`, the environment
    (JavaScriptCore) is incompatible with V8-specific native modules, or the
    binary is simply missing/failed to load.
  - >-
    This crash happens at **module load time** (when `scenarios.test.ts` imports
    the tool definitions), preventing any tests from runningâ€”even those that
    might not strictly require the sandbox (like CLI tests).
  - >-
    To fix this and make the codebase more robust across environments (e.g. CI,
    Bun, or when dependencies aren't fully built), I will refactor
    `src/sandbox/isolate.ts` to **lazy-load** `isolated-vm`. The module will
    only be imported when `compileAndRun` is actually called. This prevents the
    crash at startup and allows the test runner to proceed, failing gracefully
    only within the specific tests that rely on the sandbox.
  - '### Changes'
  - '-   **Refactor `src/sandbox/isolate.ts`**:'
  - >-
    -   Switch `import ivm` to a dynamic `import('isolated-vm')` inside
    `compileAndRun`.
  - '-   Implement lazy initialization for the `Isolate` instance.'
  - >-
    -   Add error handling to provide a clear message if the environment is
    incompatible.
operations:
  - type: write
    path: src/sandbox/isolate.ts
    content: >
      --- src/sandbox/isolate.ts

      +++ src/sandbox/isolate.ts

      @@ -1,4 +1,4 @@

      -import ivm from 'isolated-vm';

      +import type * as IVM from 'isolated-vm';
       import { transform } from 'esbuild';
       
       /**
      @@ -23,11 +23,21 @@
         const memoryLimit = opts.memoryLimitMb ?? 128;
         const timeout = opts.timeoutMs ?? 5000;
       
      -  // Create the heavy V8 Isolate (The Virtual Machine)

      -  const isolate = new ivm.Isolate({ memoryLimit });

      +  let isolate: IVM.Isolate | undefined;
       
         return {
           // eslint-disable-next-line @typescript-eslint/no-explicit-any
           async compileAndRun(tsCode: string, context: Record<string, any>) {
      +      // eslint-disable-next-line @typescript-eslint/no-explicit-any

      +      let ivm: any;

      +      try {

      +        // Dynamic import to prevent crash on module load if native
      bindings are missing or incompatible

      +        ivm = (await import('isolated-vm')).default;

      +      } catch (err) {

      +        throw new Error(`Failed to load 'isolated-vm'. The TGP Sandbox
      requires a Node.js environment with native module support. Details:
      ${err}`);

      +      }

      +

      +      if (!isolate) {

      +        isolate = new ivm.Isolate({ memoryLimit });

      +      }

      +
             // 1. JIT Compile (TypeScript -> JavaScript)
             // We use esbuild for speed.
      @@ -39,12 +49,13 @@
             });
       
             const jsCode = transformed.code;
       
             // 2. Create a fresh Context for this execution
             const ivmContext = await isolate.createContext();
       
             try {
               // 3. Bridge the Global Scope (Host -> Guest)
               const jail = ivmContext.global;
               
               // Inject the 'tgp' global object which holds our bridge
               await jail.set('global', jail.derefInto()); // standard polyfill
      @@ -62,13 +73,13 @@
                       for (const [subKey, subValue] of Object.entries(value)) {
                           if (typeof subValue === 'function') {
                              // Functions must be passed by Reference
                              await tgpHandle.set(subKey, new ivm.Reference(subValue));
                           } else {
                              // Values are copied
                              await tgpHandle.set(subKey, new ivm.ExternalCopy(subValue).copyInto());
                           }
                       }
                   } 
                   // Handle top-level functions (like __tgp_load_module)
                   else if (typeof value === 'function') {
                     await jail.set(key, new ivm.Reference(value));
      @@ -76,14 +87,14 @@
                   } 
                   // Handle standard values
                   else {
                     await jail.set(key, new ivm.ExternalCopy(value).copyInto());
                   }
               }
       
               // 4. Compile the Script inside the Isolate
               const script = await isolate.compileScript(jsCode);
       
               // 5. Execute
               const result = await script.run(ivmContext, { timeout });
               
               // 6. Return result (Unwrap from IVM)
      @@ -95,8 +106,8 @@
           },
       
           dispose() {
      -      if (!isolate.isDisposed) {

      +      if (isolate && !isolate.isDisposed) {
               isolate.dispose();
             }
           }
         };
       }
    patchStrategy: standard-diff
snapshot:
  src/sandbox/isolate.ts: |-
    import ivm from 'isolated-vm';
    import { transform } from 'esbuild';

    /**
     * Configuration for the V8 Sandbox.
     */
    export interface SandboxOptions {
      memoryLimitMb?: number; // Default 128MB
      timeoutMs?: number;     // Default 5000ms
    }

    export interface Sandbox {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      compileAndRun: (code: string, context: Record<string, any>) => Promise<any>;
      dispose: () => void;
    }

    /**
     * Creates a secure V8 Isolate.
     */
    export function createSandbox(opts: SandboxOptions = {}): Sandbox {
      const memoryLimit = opts.memoryLimitMb ?? 128;
      const timeout = opts.timeoutMs ?? 5000;

      // Create the heavy V8 Isolate (The Virtual Machine)
      const isolate = new ivm.Isolate({ memoryLimit });

      return {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        async compileAndRun(tsCode: string, context: Record<string, any>) {
          // 1. JIT Compile (TypeScript -> JavaScript)
          // We use esbuild for speed.
          const transformed = await transform(tsCode, {
            loader: 'ts',
            format: 'cjs', // CommonJS ensures simple execution in V8
            target: 'es2020',
          });

          const jsCode = transformed.code;

          // 2. Create a fresh Context for this execution
          const ivmContext = await isolate.createContext();

          try {
            // 3. Bridge the Global Scope (Host -> Guest)
            const jail = ivmContext.global;
            
            // Inject the 'tgp' global object which holds our bridge
            await jail.set('global', jail.derefInto()); // standard polyfill

            // Inject Context
            for (const [key, value] of Object.entries(context)) {
                // Special handling for the 'tgp' namespace object
                if (key === 'tgp' && typeof value === 'object' && value !== null) {
                    // Initialize the namespace in the guest
                    await isolate.compileScript('global.tgp = {}').then(s => s.run(ivmContext));
                    const tgpHandle = await jail.get('tgp');
                    
                    // Populate the namespace
                    for (const [subKey, subValue] of Object.entries(value)) {
                        if (typeof subValue === 'function') {
                           // Functions must be passed by Reference
                           await tgpHandle.set(subKey, new ivm.Reference(subValue));
                        } else {
                           // Values are copied
                           await tgpHandle.set(subKey, new ivm.ExternalCopy(subValue).copyInto());
                        }
                    }
                } 
                // Handle top-level functions (like __tgp_load_module)
                else if (typeof value === 'function') {
                  await jail.set(key, new ivm.Reference(value));
                } 
                // Handle standard values
                else {
                  await jail.set(key, new ivm.ExternalCopy(value).copyInto());
                }
            }

            // 4. Compile the Script inside the Isolate
            const script = await isolate.compileScript(jsCode);

            // 5. Execute
            const result = await script.run(ivmContext, { timeout });
            
            // 6. Return result (Unwrap from IVM)
            if (typeof result === 'object' && result !== null && 'copy' in result) {
                // If it's a reference, try to copy it out, otherwise return as is
                return result.copy();
            }
            return result;

          } finally {
            // Cleanup the context to free memory immediately
            ivmContext.release();
          }
        },

        dispose() {
          if (!isolate.isDisposed) {
            isolate.dispose();
          }
        }
      };
    }
approved: true
linesAdded: 16
linesRemoved: 4
linesDifference: 20
gitCommittedAt: '2025-11-28T06:18:25.370Z'
status: committed
id: 47
