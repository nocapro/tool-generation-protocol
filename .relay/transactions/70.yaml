uuid: 4f128e4e-0a1a-42c2-b88a-36018590c427
projectId: tool-generation-protocol
createdAt: '2025-11-28T09:47:55.083Z'
gitCommitMsg: >-
  test: Upgrade MockLanguageModel to v2 spec for AI SDK 5 compatibility

  The Vercel AI SDK v5 requires language models to implement specification
  version 'v2'. Updated the test fixture and integration test to comply with the
  new specification, resolving the AI_UnsupportedModelVersionError.
promptSummary: >-
  Fixed AI SDK 5 compatibility error by upgrading MockLanguageModel to v2
  specification.
reasoning:
  - >-
    The failure in `test/integration/vercel.test.ts` is caused by
    `AI_UnsupportedModelVersionError`. The installed version of the Vercel AI
    SDK (`ai` v5.0.104) requires language models to implement the **v2
    specification**, but the mock model in `test/fixtures/fake-model.ts` was
    implementing **v1**.
  - 'I will upgrade the `MockLanguageModel` to the v2 specification by:'
  - >-
    1.  Updating `test/fixtures/fake-model.ts` to export `MockLanguageModelV2`,
    setting `specificationVersion = 'v2'`, and removing dependencies on v1
    types.
  - 2.  Updating `test/integration/vercel.test.ts` to use `MockLanguageModelV2`.
  - This ensures compatibility with AI SDK 5.
operations:
  - type: write
    path: test/fixtures/fake-model.ts
    content: |-
      /**
       * A deterministic Mock LLM that implements the Vercel AI SDK LanguageModelV2 interface.
       * Used to verify tool execution without network calls or spies.
       */
      export class MockLanguageModelV2 {
        readonly specificationVersion = 'v2';
        readonly provider = 'tgp-mock';
        readonly modelId = 'mock-v2';
        readonly defaultObjectGenerationMode = 'json';
        
        constructor(private queue: Array<(args: any) => any>) {}

        async doGenerate(options: any): Promise<any> {
          const next = this.queue.shift();
          if (!next) {
            const history = options && options.prompt ? JSON.stringify(options.prompt, null, 2) : 'unknown';
            throw new Error(`MockLanguageModelV2: Unexpected call to doGenerate. History: ${history}`);
          }
          return next(options);
        }

        async doStream(): Promise<any> {
          throw new Error('MockLanguageModelV2: doStream is not implemented for this test.');
        }
      }
    patchStrategy: replace
  - type: write
    path: test/integration/vercel.test.ts
    content: |
      --- test/integration/vercel.test.ts
      +++ test/integration/vercel.test.ts
      @@ -6,7 +6,7 @@
       import { TGP } from '../../src/tgp.js';
       import { tgpTools } from '../../src/tools/index.js';
      -import { MockLanguageModelV1 } from '../fixtures/fake-model.js';
      +import { MockLanguageModelV2 } from '../fixtures/fake-model.js';
       
       describe('Integration: Vercel AI SDK Compatibility', () => {
         let tempDir: string;
      @@ -36,7 +36,7 @@
           // Turn 1: Model receives user prompt -> Calls 'write_file'
           // Turn 2: Model receives tool result -> Returns final text
      -    const mockModel = new MockLanguageModelV1([
      +    const mockModel = new MockLanguageModelV2([
             // Response 1: Request Tool Execution
             () => ({
               rawCall: { raw: 'call' },
    patchStrategy: standard-diff
snapshot:
  test/fixtures/fake-model.ts: |-
    import { 
      LanguageModelV1, 
      LanguageModelV1CallResult, 
      LanguageModelV1CallOptions 
    } from 'ai';

    /**
     * A deterministic Mock LLM that implements the Vercel AI SDK LanguageModelV1 interface.
     * Used to verify tool execution without network calls or spies.
     */
    export class MockLanguageModelV1 implements LanguageModelV1 {
      readonly specificationVersion = 'v1';
      readonly provider = 'tgp-mock';
      readonly modelId = 'mock-v1';
      readonly defaultObjectGenerationMode = 'json';
      
      constructor(private queue: Array<(args: LanguageModelV1CallOptions) => LanguageModelV1CallResult>) {}

      async doGenerate(options: LanguageModelV1CallOptions): Promise<LanguageModelV1CallResult> {
        const next = this.queue.shift();
        if (!next) {
          throw new Error(`MockLanguageModelV1: Unexpected call to doGenerate. History: ${JSON.stringify(options.prompt, null, 2)}`);
        }
        return next(options);
      }

      async doStream(): Promise<any> {
        throw new Error('MockLanguageModelV1: doStream is not implemented for this test.');
      }
    }
  test/integration/vercel.test.ts: >-
    import { describe, it, expect, beforeEach, afterEach } from 'bun:test';

    import * as fs from 'fs/promises';

    import * as path from 'path';

    import { generateText } from 'ai';

    import { createTempDir, createTgpConfig, cleanupDir, initBareRepo } from
    '../e2e/utils.js';

    import { TGP } from '../../src/tgp.js';

    import { tgpTools } from '../../src/tools/index.js';

    import { MockLanguageModelV1 } from '../fixtures/fake-model.js';


    describe('Integration: Vercel AI SDK Compatibility', () => {
      let tempDir: string;
      let remoteRepo: string;

      beforeEach(async () => {
        tempDir = await createTempDir('tgp-int-vercel-');
        remoteRepo = await createTempDir('tgp-remote-');
        await initBareRepo(remoteRepo);
      });

      afterEach(async () => {
        await cleanupDir(tempDir);
        await cleanupDir(remoteRepo);
      });

      it('End-to-End: generateText executes TGP tools correctly', async () => {
        // 1. Setup Kernel
        const configPath = await createTgpConfig(tempDir, remoteRepo);
        const kernel = new TGP({ configFile: configPath });
        await kernel.boot();

        // 2. Prepare Toolset
        const tools = tgpTools(kernel);

        // 3. Setup Fake Model Interaction
        // The interaction simulates:
        // Turn 1: Model receives user prompt -> Calls 'write_file'
        // Turn 2: Model receives tool result -> Returns final text
        const mockModel = new MockLanguageModelV1([
          // Response 1: Request Tool Execution
          () => ({
            rawCall: { raw: 'call' },
            finishReason: 'tool-calls',
            usage: { promptTokens: 10, completionTokens: 10 },
            toolCalls: [
              {
                toolCallType: 'function',
                toolCallId: 'call_1',
                toolName: 'write_file',
                // Vercel SDK expects args as a JSON string
                args: JSON.stringify({ path: 'tools/hello-vercel.ts', content: 'export default "compat"' }),
              }
            ]
          }),
          // Response 2: Final Summary
          (opts) => {
            // Assert that the SDK fed the tool result back to the model
            const lastMsg = opts.prompt[opts.prompt.length - 1];
            if (lastMsg.role !== 'tool' || lastMsg.content[0].type !== 'tool-result') {
              throw new Error('Expected last message to be a tool result');
            }
            
            return {
              rawCall: { raw: 'response' },
              finishReason: 'stop',
              usage: { promptTokens: 20, completionTokens: 5 },
              text: 'File created successfully.'
            };
          }
        ]);

        // 4. Execute using Vercel AI SDK
        const result = await generateText({
          model: mockModel,
          tools: tools, // Type Check: This must compile
          maxSteps: 2,  // Allow tool roundtrips
          prompt: 'Create a file named tools/hello-vercel.ts',
        });

        // 5. Verify Results
        expect(result.text).toBe('File created successfully.');
        expect(result.toolCalls.length).toBe(1);
        expect(result.toolCalls[0].toolName).toBe('write_file');

        // 6. Verify Side Effects (Real Filesystem Check)
        // The VFS root is at .tgp inside tempDir (configured by createTgpConfig)
        const targetFile = path.join(tempDir, '.tgp/tools/hello-vercel.ts');
        const exists = await fs.access(targetFile).then(() => true).catch(() => false);
        
        expect(exists).toBe(true);
        
        const content = await fs.readFile(targetFile, 'utf-8');
        expect(content).toBe('export default "compat"');
      });
    });
approved: true
linesAdded: 11
linesRemoved: 16
linesDifference: 27
gitCommittedAt: null
status: committed
id: 70
