uuid: afc6114b-70c3-42e7-9d6c-66f85d26338b
projectId: tool-generation-protocol
createdAt: '2025-11-28T01:41:51.642Z'
gitCommitMsg: >-
  refactor(kernel): Decouple database from TGP core

  Removes the DBBackend interface and all related abstractions from the TGP
  kernel.

  This change simplifies the kernel's responsibilities, focusing it solely on
  providing a secure execution environment. The host application is now
  responsible for database interactions.

  Introduces a new `exec_sql` tool pattern via a `createSqlTools` factory. This
  allows the host to inject its own database execution logic, creating a clean
  and robust boundary between the agent's capabilities and the application's
  core infrastructure.
promptSummary: >-
  The user requested a retry of Part 1 after a patch failure. This attempt uses
  more careful, non-overlapping hunks to ensure the patches apply correctly.
reasoning:
  - >-
    You are correct. The last attempt failed due to an overlapping patch. My
    apologies. The automated diff generation was too aggressive. I will be more
    careful this time, ensuring the patch hunks are discrete and do not overlap.
  - Let's retry executing Part 1.
  - '### Step 1: Purge DB Abstractions from Core Types'
  - >-
    I'll start by removing the `DBBackend` interface from `src/types.ts`. This
    change is simple and at the end of the file, posing no risk of conflict.
  - '### Step 2: Remove DB from Kernel and TGP Class'
  - First, I will delete the now-unused `db.ts` file.
  - >-
    Next, I'll remove the database logic from `src/kernel/core.ts` using
    carefully separated hunks to avoid overlap.
  - >-
    Now, I will apply the same careful process to `src/tgp.ts`, using multiple
    non-overlapping hunks to ensure the patch applies correctly.
  - '### Step 3: Introduce the `exec_sql` Agent Tool'
  - >-
    I will now create the new file `src/tools/sql.ts`. This introduces the
    database tool factory, allowing the host application to inject its own
    database execution logic safely.
  - >-
    Finally, I'll export the new factory from the main `tools` index to make it
    accessible to users.
  - >-
    This set of changes correctly executes Part 1 of the plan and should apply
    without patching errors.
operations:
  - type: write
    path: src/types.ts
    content: >
      --- src/types.ts

      +++ src/types.ts

      @@ -95,29 +95,3 @@
         warn(message: string, ...args: any[]): void;
         error(message: string, ...args: any[]): void;
       }
      -

      -/**

      - * The Database Kernel Interface.

      - *

      - * TGP guarantees that all tool executions happen within a transaction.

      - * If the tool throws, the transaction is rolled back.

      - * This interface must be implemented by the host application and
      injected into the TGP Kernel.

      - */

      -export interface DBBackend {

      -  /**

      -   * Executes a raw SQL query.

      -   * @param sql The SQL query string.

      -   * @param params Parameter substitutions.

      -   */

      -  // eslint-disable-next-line @typescript-eslint/no-explicit-any

      -  query(sql: string, params?: any[]): Promise<any[]>;

      -

      -  /**

      -   * Wraps a function in a database transaction.

      -   * @param fn The function to execute. It receives a transactional DB
      instance.

      -   */

      -  transaction<T>(fn: (trx: DBBackend) => Promise<T>): Promise<T>;

      -}
    patchStrategy: standard-diff
  - type: delete
    path: src/kernel/db.ts
  - type: write
    path: src/kernel/core.ts
    content: |
      --- src/kernel/core.ts
      +++ src/kernel/core.ts
      @@ -1,7 +1,6 @@
       /* eslint-disable no-console */
      -import { TGPConfig, Logger, DBBackend } from '../types.js';
      +import { TGPConfig, Logger } from '../types.js';
       import { VFSAdapter } from '../vfs/types.js';
       import { createGitBackend, GitBackend, GitDependencies } from './git.js';
      -import { createNoOpDB } from './db.js';
       import { createRegistry, Registry } from './registry.js';
       
       // We inject the platform-specific environment dependencies here.
      @@ -14,21 +13,18 @@
         vfs: VFSAdapter; 
         env: KernelEnvironment;
         logger?: Logger;
      -  db?: DBBackend;
       }
       
       export interface Kernel {
         boot(): Promise<void>;
         shutdown(): Promise<void>;
         config: TGPConfig;
         vfs: VFSAdapter;
         git: GitBackend;
      -  db: DBBackend;
         registry: Registry;
         logger: Logger;
       }
      @@ -43,17 +39,15 @@
         const logger = opts.logger ?? defaultLogger;
         
         const git = createGitBackend(env, config, logger);
      -  const db = opts.db ?? createNoOpDB(); 
         const registry = createRegistry(vfs);
       
         let isBooted = false;
       
         return {
           config,
           vfs,
           git,
      -    db,
           registry,
           logger,
       
    patchStrategy: standard-diff
  - type: write
    path: src/tgp.ts
    content: >
      --- src/tgp.ts

      +++ src/tgp.ts

      @@ -2,7 +2,7 @@
       import * as http from 'isomorphic-git/http/node';
       import { createKernel, Kernel, KernelEnvironment } from './kernel/core.js';
       import { loadTGPConfig } from './config.js';
       import { createNodeVFS } from './vfs/node.js';
      -import { TGPConfigSchema, TGPConfig, Logger, DBBackend } from
      './types.js';

      +import { TGPConfigSchema, TGPConfig, Logger } from './types.js';
       import { VFSAdapter } from './vfs/types.js';
       import { GitBackend } from './kernel/git.js';
       import { Registry } from './kernel/registry.js';
      @@ -22,11 +22,6 @@
          */
         logger?: Logger;
       
      -  /**

      -   * Inject a custom Database Backend.

      -   */

      -  db?: DBBackend;

      -
         /**
          * Override the raw filesystem used by Git.
          * If omitted, defaults to 'node:fs'.
      @@ -46,7 +41,6 @@
         public config: TGPConfig;
         public vfs: VFSAdapter;
         public git: GitBackend;
      -  public db: DBBackend;
         public registry: Registry;
         public logger: Logger;
         
      @@ -66,12 +60,10 @@
             config: this.config,
             vfs: this.vfs,
             env,
      -      logger: opts.logger,

      -      db: opts.db

      +      logger: opts.logger
           });
       
           this.git = kernel.git;
      -    this.db = kernel.db;
           this.registry = kernel.registry;
           this.logger = kernel.logger;
         }
      @@ -98,13 +90,11 @@
               config: this.config,
               vfs: this.vfs,
               env,
      -        logger: this.opts.logger,

      -        db: this.opts.db

      +        logger: this.opts.logger
             });
             
             this.git = kernel.git;
      -      this.db = kernel.db;
             this.registry = kernel.registry;
       
             // 4. Hydrate State (Git Clone/Pull + Registry Build)
    patchStrategy: standard-diff
  - type: write
    path: src/tools/sql.ts
    content: |-
      import { z } from 'zod';
      import { AgentTool, ToolSet } from './types.js';

      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      export type DBExecutor = (sql: string, params: any[]) => Promise<any[]>;

      export const ExecSqlParams = z.object({
        sql: z.string().describe('The raw SQL query to execute.'),
        params: z.array(z.any()).optional().describe('An array of parameters to substitute into the query.'),
      });

      /**
       * Creates a ToolSet containing the `exec_sql` tool.
       * This function allows the host application to inject its own database connection
       * and execution logic into the TGP agent.
       *
       * @param executor A function that takes a SQL string and parameters and returns the result.
       * @returns A ToolSet containing the `exec_sql` tool.
       */
      export function createSqlTools(executor: DBExecutor): ToolSet {
        return {
          exec_sql: {
            description: 'Executes a raw SQL query against the database. Returns an array of rows.',
            parameters: ExecSqlParams,
            execute: async ({ sql, params }) => {
              return executor(sql, params || []);
            },
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          } as AgentTool<typeof ExecSqlParams, any[]>,
        };
      }
    patchStrategy: replace
  - type: write
    path: src/tools/index.ts
    content: |
      --- src/tools/index.ts
      +++ src/tools/index.ts
      @@ -5,6 +5,7 @@
       import { ToolSet } from './types.js';
       
       export * from './types.js';
      +export * from './sql.js';
       
       /**
        * Generates the complete set of TGP tools (Capabilities) for a given Kernel.
    patchStrategy: standard-diff
snapshot:
  src/tools/sql.ts: null
  src/types.ts: |-
    import { z } from 'zod';

    // --- Git Configuration Schema ---
    export const GitConfigSchema = z.object({
      provider: z.enum(['github', 'gitlab', 'bitbucket']),
      repo: z.string().min(1, "Repository name is required"),
      branch: z.string().default('main'),
      apiBaseUrl: z.string().url().default('https://api.github.com'),
      auth: z.object({
        token: z.string().min(1, "Git auth token is required"),
        user: z.string().default('tgp-bot[bot]'),
        email: z.string().email().default('tgp-bot@users.noreply.github.com'),
      }),
      writeStrategy: z.enum(['direct', 'pr']).default('direct'),
    });

    // --- Filesystem Jail Schema ---
    export const FSConfigSchema = z.object({
      allowedDirs: z.array(z.string()).default(['./tmp']),
      blockUpwardTraversal: z.boolean().default(true),
    });

    // --- Main TGP Configuration Schema ---
    export const TGPConfigSchema = z.object({
      rootDir: z.string().default('./.tgp'),
      git: GitConfigSchema,
      fs: FSConfigSchema.default({}),
      allowedImports: z.array(z.string()).default(['@tgp/std', 'zod', 'date-fns']),
      allowedFetchUrls: z.array(z.string()).optional().describe('Whitelist of URL prefixes the sandbox fetch can access.'),
    });

    // --- Inferred Static Types ---
    // We export these so the rest of the app relies on the Zod inference, 
    // ensuring types and validation never drift apart.
    export type GitConfig = z.infer<typeof GitConfigSchema>;
    export type FSConfig = z.infer<typeof FSConfigSchema>;
    export type TGPConfig = z.infer<typeof TGPConfigSchema>;

    /**
     * Defines the structure for a tool file persisted in the VFS.
     * This is what resides in ./.tgp/tools/
     */
    export const ToolSchema = z.object({
      name: z.string(),
      description: z.string(),
      parameters: z.record(z.unknown()), // JsonSchema
      code: z.string(), // The raw TypeScript source
    });

    export type ToolDefinition = z.infer<typeof ToolSchema>;

    export interface ToolMetadata {
      name: string;
      description: string;
      path: string;
    }

    export interface RegistryState {
      tools: Record<string, ToolMetadata>;
    }

    export interface Logger {
      debug(message: string, ...args: any[]): void;
      info(message: string, ...args: any[]): void;
      warn(message: string, ...args: any[]): void;
      error(message: string, ...args: any[]): void;
    }

    /**
     * The Database Kernel Interface.
     *
     * TGP guarantees that all tool executions happen within a transaction.
     * If the tool throws, the transaction is rolled back.
     * This interface must be implemented by the host application and injected into the TGP Kernel.
     */
    export interface DBBackend {
      /**
       * Executes a raw SQL query.
       * @param sql The SQL query string.
       * @param params Parameter substitutions.
       */
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      query(sql: string, params?: any[]): Promise<any[]>;

      /**
       * Wraps a function in a database transaction.
       * @param fn The function to execute. It receives a transactional DB instance.
       */
      transaction<T>(fn: (trx: DBBackend) => Promise<T>): Promise<T>;
    }
  src/kernel/db.ts: |-
    /* eslint-disable no-console */
    import { DBBackend } from '../types.js';

    /**
     * A No-Op Database Backend used when no DB is configured.
     * It logs operations to the console and is useful for testing or running without a database.
     */
    export function createNoOpDB(): DBBackend {
      return {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        async query(sql: string, params: any[] = []) {
          console.log(`[TGP-DB] Query: ${sql}`, params);
          return [];
        },

        async transaction<T>(fn: (trx: DBBackend) => Promise<T>): Promise<T> {
          console.log(`[TGP-DB] Begin Transaction`);
          try {
            // In a real DB, we would start a trx here.
            // We pass 'this' as the transactional client (NoOp doesn't distinguish)
            const result = await fn(this);
            console.log(`[TGP-DB] Commit Transaction`);
            return result;
          } catch (err) {
            console.log(`[TGP-DB] Rollback Transaction`);
            throw err;
          }
        }
      };
    }
  src/kernel/core.ts: |-
    /* eslint-disable no-console */
    import { TGPConfig, Logger, DBBackend } from '../types.js';
    import { VFSAdapter } from '../vfs/types.js';
    import { createGitBackend, GitBackend, GitDependencies } from './git.js';
    import { createNoOpDB } from './db.js';
    import { createRegistry, Registry } from './registry.js';

    // We inject the platform-specific environment dependencies here.
    // This allows the Kernel to run in Node, Edge, or Browser environments.
    export interface KernelEnvironment extends GitDependencies {
      // We can extend this if Kernel needs more platform specific components later
    }

    export interface KernelOptions {
      config: TGPConfig;
      vfs: VFSAdapter; 
      env: KernelEnvironment;
      logger?: Logger;
      db?: DBBackend;
    }

    export interface Kernel {
      boot(): Promise<void>;
      shutdown(): Promise<void>;
      config: TGPConfig;
      vfs: VFSAdapter;
      git: GitBackend;
      db: DBBackend;
      registry: Registry;
      logger: Logger;
    }

    const defaultLogger: Logger = {
      debug: (msg, ...args) => console.debug(`[TGP] ${msg}`, ...args),
      info: (msg, ...args) => console.log(`[TGP] ${msg}`, ...args),
      warn: (msg, ...args) => console.warn(`[TGP] ${msg}`, ...args),
      error: (msg, ...args) => console.error(`[TGP] ${msg}`, ...args),
    };

    /**
     * Factory to create a TGP Kernel.
     * This wires up the configuration, the filesystem, and the git backend.
     */
    export function createKernel(opts: KernelOptions): Kernel {
      const { config, vfs, env } = opts;
      const logger = opts.logger ?? defaultLogger;
      
      const git = createGitBackend(env, config, logger);
      const db = opts.db ?? createNoOpDB(); 
      const registry = createRegistry(vfs);

      let isBooted = false;

      return {
        config,
        vfs,
        git,
        db,
        registry,
        logger,

        async boot() {
          if (isBooted) return;
          logger.info(`Kernel booting...`);
          
          try {
            // Hydrate the filesystem from Git
            await git.hydrate().catch(err => {
              logger.error(`Git hydration failed.`, err);
              throw err;
            });
            
            // Hydrate registry from meta.json
            await registry.hydrate().catch(err => logger.warn(`Registry hydration warning:`, err));
            
            isBooted = true;
            logger.info(`Kernel ready.`);
          } catch (error) {
            logger.error(`Boot failed:`, error);
            throw error;
          }
        },

        async shutdown() {
          logger.info(`Kernel shutting down...`);
          // Cleanup tasks (close db connections, etc) can go here
          isBooted = false;
        }
      };
    }
  src/tgp.ts: >-
    import * as fs from 'node:fs';

    import * as http from 'isomorphic-git/http/node';

    import { createKernel, Kernel, KernelEnvironment } from './kernel/core.js';

    import { loadTGPConfig } from './config.js';

    import { createNodeVFS } from './vfs/node.js';

    import { TGPConfigSchema, TGPConfig, Logger, DBBackend } from './types.js';

    import { VFSAdapter } from './vfs/types.js';

    import { GitBackend } from './kernel/git.js';

    import { Registry } from './kernel/registry.js';


    export interface TGPOptions {
      /**
       * Path to the configuration file.
       * @default "./tgp.config.ts"
       */
      configFile?: string;

      /**
       * Override the Virtual Filesystem Adapter.
       * Useful for using MemoryVFS in tests or Edge environments.
       * If omitted, defaults to NodeVFS rooted at config.rootDir.
       */
      vfs?: VFSAdapter;

      /**
       * Inject a custom logger. Defaults to console.
       */
      logger?: Logger;

      /**
       * Inject a custom Database Backend.
       */
      db?: DBBackend;

      /**
       * Override the raw filesystem used by Git.
       * If omitted, defaults to 'node:fs'.
       */
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      fs?: any;

      /**
       * Override the HTTP client used by Git.
       * If omitted, defaults to 'isomorphic-git/http/node'.
       */
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      http?: any;
    }


    /**
     * The TGP Kernel Class.
     * Manages the lifecycle of the Agent's runtime environment, including
     * configuration, filesystem (VFS), Git persistence, and the Tool Registry.
     */
    export class TGP implements Kernel {
      public config: TGPConfig;
      public vfs: VFSAdapter;
      public git: GitBackend;
      public db: DBBackend;
      public registry: Registry;
      public logger: Logger;
      
      private _isBooted = false;

      constructor(private opts: TGPOptions = {}) {
        // 1. Initialize with Defaults (Sync)
        // We use the default schema to ensure the kernel is usable immediately (e.g. for tooling)
        // even before the async config load completes.
        this.config = TGPConfigSchema.parse({});
        
        // 2. Setup VFS
        // Use injected VFS or default to Node VFS
        this.vfs = opts.vfs || createNodeVFS(this.config.rootDir);

        // 3. Initialize Kernel Components
        // Construct Environment with defaults if not provided
        const env: KernelEnvironment = {
          fs: opts.fs || fs,
          http: opts.http || http
        };

        const kernel = createKernel({
          config: this.config,
          vfs: this.vfs,
          env,
          logger: opts.logger,
          db: opts.db
        });

        this.git = kernel.git;
        this.db = kernel.db;
        this.registry = kernel.registry;
        this.logger = kernel.logger;
      }

      /**
       * Hydrates the Kernel from the configuration file and Git.
       * This must be awaited before executing tools in production.
       */
      async boot(): Promise<void> {
        if (this._isBooted) return;

        const configPath = this.opts.configFile || './tgp.config.ts';

        try {
          // 1. Load Real Configuration
          const loadedConfig = await loadTGPConfig(configPath);
          this.config = loadedConfig;

          // 2. Re-initialize VFS if RootDir changed AND user didn't inject a custom VFS
          // If the user injected a VFS, we assume they configured it correctly.
          if (!this.opts.vfs) {
            this.vfs = createNodeVFS(this.config.rootDir);
          }

          // 3. Re-initialize Kernel Components with new Config/VFS
          const env: KernelEnvironment = {
            fs: this.opts.fs || fs,
            http: this.opts.http || http
          };

          const kernel = createKernel({
            config: this.config,
            vfs: this.vfs,
            env,
            logger: this.opts.logger,
            db: this.opts.db
          });
          
          this.git = kernel.git;
          this.db = kernel.db;
          this.registry = kernel.registry;

          // 4. Hydrate State (Git Clone/Pull + Registry Build)
          await kernel.boot();
          
          this._isBooted = true;
        } catch (error) {
          // If config loading fails, we might still be in a valid default state,
          // but we should warn the user.
          console.warn(`[TGP] Boot warning:`, error);
          throw error;
        }
      }

      async shutdown(): Promise<void> {
        // Passthrough to internal kernel shutdown if needed
        this._isBooted = false;
      }

      /**
       * Generates the System Prompt enforcing the "8 Standards" and TGP protocol.
       */
      getSystemPrompt(): string {
        return `
    You are an autonomous AI Engineer running on the Tool Generation Protocol
    (TGP).

    Your goal is to build, validate, and execute tools to solve the user's
    request.


    # THE PROTOCOL


    1.  **Reuse or Forge**: Check if a tool exists. If not, write it.

    2.  **No One-Offs**: Do not execute arbitrary scripts. Create a reusable
    tool in 'tools/'.

    3.  **Strict Typing**: All tools must be written in TypeScript. No 'any', no
    'unknown'.


    # CODING STANDARDS (The 8 Commandments)


    1.  **Abstract**: Logic must be separated from data. (e.g., args.taxRate,
    not 0.05).

    2.  **Composable**: Functions should return results usable by others.

    3.  **HOFs**: Use map/reduce/filter over imperative loops.

    4.  **Stateless**: No global state. No reliance on previous execution.

    5.  **Reusable**: Generic enough for multiple use cases.

    6.  **General by Params**: Behavior controlled by arguments.

    7.  **No Hardcoded Values**: No magic numbers or IDs.

    8.  **Orchestrator**: Tools can import other tools via 'require'.


    # EXECUTION FLOW


    1.  List files to see what you have.

    2.  Read file content to understand the tool.

    3.  If missing, write_file to create a new tool.

    4.  Use check_tool to validate syntax.

    5.  Use exec_tool to run it.

    `;
      }
    }
  src/tools/index.ts: |-
    import { Kernel } from '../kernel/core.js';
    import { createFsTools } from './fs.js';
    import { createValidationTools } from './validation.js';
    import { createExecTools } from './exec.js';
    import { ToolSet } from './types.js';

    export * from './types.js';

    /**
     * Generates the complete set of TGP tools (Capabilities) for a given Kernel.
     * These are the tools the Agent will use to build, test, and run the user-land tools.
     */
    export function tgpTools(kernel: Kernel): ToolSet {
      return {
        ...createFsTools(kernel),
        ...createValidationTools(kernel),
        ...createExecTools(kernel),
      };
    }
approved: true
linesAdded: 36
linesRemoved: 72
linesDifference: 108
gitCommittedAt: null
status: committed
id: 34
